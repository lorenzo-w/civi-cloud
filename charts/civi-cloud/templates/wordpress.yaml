kind: ConfigMap
apiVersion: v1
metadata:
  name: wordpress-autoconfig
data:
  setup.sh: |
    #!/bin/bash
    until $(curl --output /dev/null --silent --head --fail http://localhost:8080/wp-login.php); do
      echo 'waiting for wordpress to start...'
      sleep 5
    done
    echo 'wordpress is up.'
    echo 'installing plugins...'
    for PLUGIN in $(cat plugins.txt); do
      echo "installing $PLUGIN"
      wp plugin install $PLUGIN --activate
    done
    echo 'installing plugins... done'
    echo 'loading options...'
    mapfile OPTIONS < options.txt
    for OPTION in $OPTIONS; do
      wp option update $OPTION
    done
    echo 'loading options... done'
    echo 'wordpress all set up.'
  plugins.txt: | 
    advanced-custom-fields
    broken-link-checker
    contact-form-7
    doliconnect
    duplicate-page
    gutenberg
    matomo
    miniorange-saml-20-single-sign-on
    permalink-manager
    public-post-preview
    super-progressive-web-apps
    wordpress-seo
    wp-discourse
    wp-phpmyadmin-extension
    wp-smushit
    https://github.com/frontity/frontity-embedded/archive/refs/heads/master.zip
  options.txt: |
    saml_identity_name Test
---
apiVersion: v1
kind: Secret
metadata:
  name: wordpress-db
type: Opaque
data:
  mariadb-password: {{ include "common.secrets.passwords.manage" (dict "secret" "wordpress-db" "key" "mariadb-password" "providedValues" (list "") "context" $) }}
  mariadb-root-password: {{ include "common.secrets.passwords.manage" (dict "secret" "wordpress-db" "key" "mariadb-root-password" "providedValues" (list "") "context" $) }}
  mariadb-replication-password: {{ include "common.secrets.passwords.manage" (dict "secret" "wordpress-db" "key" "mariadb-replication-password" "providedValues" (list "") "context" $) }}
---
apiVersion: v1
kind: Secret
metadata:
  name: wordpress
type: Opaque
data:
  wordpress-password: {{ include "common.secrets.passwords.manage" (dict "secret" "wordpress" "key" "wordpress-password" "providedValues" (list "") "context" $) }}
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: wordpress
spec:
  interval: 5m
  chart:
    spec:
      chart: wordpress
      version: '14.3.2'
      sourceRef:
        kind: HelmRepository
        name: bitnami
  timeout: 10m0s # Increase timeout to be sure.
  dependsOn:
    - name: sso-clients
  values:
    ingress:
      enabled: true
      hostname: {{ printf "%s.%s" .Values.subdomains.wordpress .Values.domain }}
      tls: true
      annotations:
        cert-manager.io/cluster-issuer: acme
    wordpressUsername: admin
    wordpressEmail: {{ include "get_sso_config" (dict "key" "admin_email" "context" $) }}
    existingSecret: wordpress
    wordpressBlogName: {{ .Values.org.name | quote }}
    wordpressScheme: https
    wordpressExtraConfigContent: | 
      define( 'WPLANG', {{ .Values.org.defaultLocale | quote }} );
    wordpressConfigureCache: true
    extraVolumes:
      - name: autoconfig
        configMap:
          name: wordpress-autoconfig
    extraVolumeMounts:
      - name: autoconfig
        mountPath: /autoconfig
        readOnly: true
    customPostInitScripts:
      autoconfig.sh: |
        #!/bin/bash
        cd /autoconfig
        ./setup.sh
    smtpHost: {{ .Values.smtp.host }}
    smtpPort: {{ .Values.smtp.port | quote }}
    smtpUser: {{ .Values.smtp.login | quote }}
    smtpPassword: {{ .Values.smtp.password | quote }}
    smtpProtocol: {{ .Values.smtp.tlsMode | quote }}
    service:
      type: ClusterIP
    mariadb:
      enabled: true
      fullnameOverride: wordpress-db
      auth:
        database: wordpress
        username: wordpress
        existingSecret: wordpress-db
    memcached:
      enabled: true